/*! Dessin 30-06-2014 */
var Dessin=Dessin||{};Dessin.ui=Dessin.ui||{},Dessin.BRUSH={RES_BRUSH_IMAGE_URL:"res/img/brush_circle.png",RES_CRAYON_IMAGE_URL:"res/img/brush_crayon.png",RES_AIR_BRUSH_IMAGE_URL:"res/img/brush_air.png",RES_PATTERN_IMAGE_URL:"res/img/pattern.png"},Dessin.DRAW_MODE={STROKE:0,IN_ADVANCE:1,SESSION:2},Dessin.TOOL={NONE:0,PEN:1,PAINT:2,PATTERN:3,ERASER:4,BRUSH:5,CRAYON:6,AIR_BRUSH:7,TEXT:8,PICK:9},Dessin.LAYER_ACTION={UNDO:1,REDO:2,RESET:3,ZOOMIN:4,ZOOMOUT:5,ZOOMMOVE:6,NONE:0},Dessin.ZOOM_LEVEL={MIN:0,MAX:3},Dessin.ui={DEFAULT_FONT_SIZE:20,DEFAULT_BRUSH_SIZE:10,DEFAULT_BLUR_SIZE:10,DEFAULT_MAX_SAVE_COLOR_COUNT:24},Dessin.Touch={_isMobile:function(){var a="win16|win32|win64|mac";return navigator.platform?a.indexOf(navigator.platform.toLowerCase())<0?!0:!1:void 0},_isTouch:function(){return"ontouchend"in document},hasRealTouch:function(){return this._isMobile()&&this._isTouch()},touchEvent:function(){var a=this.hasRealTouch();return{touchStartEvent:a?"touchstart":"mousedown",touchStopEvent:a?"touchend touchcancel":"mouseup",touchMoveEvent:a?"touchmove":"mousemove"}}},Dessin.Utility={getRandInt:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},changeImageColor:function(a,b,c){var d=new Image,e=document.createElement("canvas"),f=e.getContext("2d");f.clearRect(0,0,e.width,e.height),e.width=c,e.height=c,f.drawImage(a,0,0,c,c);for(var g=f.getImageData(0,0,c,c),h=0,i=g.data.length;i>h;h+=4)g.data[h]=b.r,g.data[h+1]=b.g,g.data[h+2]=b.b;return f.putImageData(g,0,0),d.src=e.toDataURL(),d},getRGBAString:function(a,b){var c=a.a/b;return"rgba("+a.r+","+a.g+","+a.b+","+c+")"},setBrushImage:function(a){void 0===this.aBrushImage&&(this.aBrushImage=[]);var b=new Image;b.src=a,b.onload=$.proxy(function(){this.aBrushImage.push(b)},this)},getImage:function(a){for(var b=this.aBrushImage,c=0,d=b.length;d>c;c+=1){var e=b[c];if(e.src.indexOf(a)>-1)return e}}},Dessin.AirBrush=function(a){this.$initAirBrush(a)},Dessin.AirBrush.prototype={$initAirBrush:function(a){this._oModel=this._createModel(a),this._oNewImage=this._createBrush(),this._nHalfSize=this._oModel.getSize()/2},_createModel:function(a){var b=new Dessin.Drawing;return a.color.a=a.color.a>1?a.color.a/100:a.color.a||1,b.setColor(a.color),b.setSize(a.size||1),b},_createBrush:function(){var a=Dessin.Utility.getImage(Dessin.BRUSH.RES_AIR_BRUSH_IMAGE_URL);return Dessin.Utility.changeImageColor(a,this._oModel.getColor(),this._oModel.getSize())},startDraw:function(){},draw:function(a,b){var c=a.getPreLayerContext();this._oModel.pushCoords(b),this._clearPrevContext(a),c.save(),this._setupConfig(c),this._drawPath(c),c.restore()},endDraw:function(a,b){var c=a.getLayerContext();this._oModel.pushCoords(b),this._clearPrevContext(a),c.save(),this._setupConfig(c),this._drawPath(c),c.restore()},_setupConfig:function(a){a.globalAlpha=this._oModel.getColor().a},_drawPath:function(a){for(var b,c,d=this._oModel.getCoords(),e=null,f=this._oNewImage,g=0,h=d.length;h>g;g+=1)e=d[g],b=e.x-this._nHalfSize,c=e.y-this._nHalfSize,a.drawImage(f,b,c)},_clearPrevContext:function(a){var b=a.getPreLayerContext(),c=b.canvas;b.clearRect(0,0,c.width,c.height)}},Dessin.Brush=function(a){_.extend(this,new Dessin.Image(a)),this.$initBrush()},Dessin.Brush.prototype={$initBrush:function(){var a=Dessin.Utility.getImage(Dessin.BRUSH.RES_BRUSH_IMAGE_URL);this.createBrush(a)}},Dessin.Crayon=function(a){_.extend(this,new Dessin.Image(a)),this.$initCrayon()},Dessin.Crayon.prototype={$initCrayon:function(){var a=Dessin.Utility.getImage(Dessin.BRUSH.RES_CRAYON_IMAGE_URL);this.createBrush(a)}},Dessin.Eraser=function(a){this.$initEraser(a)},Dessin.Eraser.prototype={$initEraser:function(a){this._oModel=new Dessin.Drawing,this._oModel.setSize(a.size||10)},startDraw:function(a,b){this._setStartCoords(b)},draw:function(a,b){var c=a.getLayerContext();this._oModel.pushCoords(b),c.save(),this._setupConfig(c),this._eraseLine(c,b),c.restore(),this._setStartCoords(b)},endDraw:function(a,b){this.draw(a,b)},_eraseLine:function(a,b){var c=this._oModel.getCoords();a.beginPath(),c.length>1?(a.moveTo(this._startCoords.x,this._startCoords.y),a.lineTo(b.x,b.y)):a.arc(b.x,b.y,.5,0,2*Math.PI,!0),a.stroke()},_setupConfig:function(a){var b=this._oModel.getStylar();a.lineCap=b,a.lineJoin=b,a.strokeStyle="rgba(0,0,0)",a.globalCompositeOperation="destination-out",a.lineWidth=this._oModel.getSize()},_setStartCoords:function(a){this._startCoords=a}},Dessin.Image=function(a){this._startCoords=null,this.$initImage(a)},Dessin.Image.prototype={$initImage:function(a){this._oModel=this._createModel(a)},_createModel:function(a){var b=new Dessin.Drawing;return b.setColor(a.color),b.setSize(a.size||1),b},createBrush:function(a){this._oNewImage=Dessin.Utility.changeImageColor(a,this._oModel.getColor(),this._oModel.getSize())},startDraw:function(a,b){this._setStartCoords(b)},draw:function(a,b){for(var c,d,e=a.getPreLayerContext(),f=this._getStartCoords(),g=this._oModel.getSize()/2,h=this._oModel.getSize()/2,i=b,j=this._distanceBetween2Points(f,i),k=this._angleBetween2Points(f,i),l=0;j>=l||0==l;l++)c=f.x+Math.sin(k)*l-g,d=f.y+Math.cos(k)*l-h,this._oModel.pushCoords({x:c,y:d});this._setStartCoords(i),this._clearPrevContext(a),this._drawPath(e)},endDraw:function(a){this._clearPrevContext(a),this._drawPath(a.getLayerContext())},_drawPath:function(a){var b=this._oModel.getCoords(),c=null;a.save(),a.globalAlpha=this._oModel.getColor().a;for(var d=0,e=b.length;e>d;d+=1)c=b[d],a.drawImage(this._oNewImage,c.x,c.y);a.restore()},_clearPrevContext:function(a){var b=a.getPreLayerContext(),c=b.canvas;b.clearRect(0,0,c.width,c.height)},_distanceBetween2Points:function(a,b){var c=b.x-a.x,d=b.y-a.y;return parseInt(Math.sqrt(Math.pow(c,2)+Math.pow(d,2)),10)},_angleBetween2Points:function(a,b){var c=b.x-a.x,d=b.y-a.y;return Math.atan2(c,d)},_setStartCoords:function(a){this._startCoords=a},_getStartCoords:function(){return this._startCoords}},Dessin.Line=function(a){this.$initLine(a)},Dessin.Line.prototype={$initLine:function(a){this._oModel=this._createModel(a)},_createModel:function(a){var b=new Dessin.Drawing;return a.color.a=a.color.a>1?a.color.a/100:a.color.a||1,b.setColor(a.color),b.setSize(a.size||1),b},createBrush:function(a){this._oNewImage=Dessin.Utility.changeImageColor(a,this._oModel.getColor(),this._oModel.getSize())},startDraw:function(a,b){this._oModel.pushCoords(b)},draw:function(a,b){var c=a.getPreLayerContext();this._oModel.pushCoords(b),this._clearPrevContext(a),c.save(),this._setupConfig(c),this._drawStroke(c,this._oModel.getCoords()),c.restore()},endDraw:function(a){var b=a.getLayerContext();this._clearPrevContext(a),b.save(),this._setupConfig(b),this._drawStroke(b,this._oModel.getCoords()),b.restore()},_setupConfig:function(a){var b=this._oModel.getStylar();a.lineCap=b,a.lineJoin=b,a.lineWidth=this._oModel.getSize(),this.setupEachConfig(a)},_clearPrevContext:function(a){var b=a.getPreLayerContext(),c=b.canvas;b.clearRect(0,0,c.width,c.height)},_drawStroke:function(a,b){var c=null,d=b[0],e=b.length;if(a.beginPath(),e>1){a.moveTo(d.x,d.y);for(var f=0;e>f;f+=1)c=b[f],a.lineTo(c.x,c.y)}else a.arc(d.x,d.y,.5,0,2*Math.PI,!0);a.stroke()}},Dessin.Paint=function(){this.DRAW_MODE=Dessin.DRAW_MODE.IN_ADVANCE,this.$init.apply(this,arguments)},Dessin.Paint.prototype={TOLERANCE:0,$init:function(a){this._oDrawing=new Dessin.Drawing,this._oDrawing.setColor(a.color||new Dessin.ColorModel({}))},startDraw:function(a,b){var c=this.TOLERANCE,d=a.getLayerElement(),e=b.x,f=b.y,g=this._oDrawing.getColor();g.a=Math.round(255*g.a);var h=function(a,b,c){return c=Math.min(255,c),(Math.abs(a.r-b.r)+Math.abs(a.g-b.g)+Math.abs(a.b-b.b)+Math.abs(a.a-b.a))/4<=c?!0:!1},i=d.getContext("2d"),j=(i.getImageData(0,0,d.width,d.height),i.getImageData(0,0,d.width,d.height)),k=4*(e+f*d.width),l=new Dessin.ColorModel({r:j.data[k],g:j.data[k+1],b:j.data[k+2],a:j.data[k+3]}),m=JSON.stringify(l),n=JSON.stringify(g);if(n==m)return!0;var o=d.width,p=d.height;if(0>e||e>=o||0>f||f>=p)return!1;for(var q=[e+f*o],r={},s=0;s<q.length;s++){var t=q[s],u=t%o,v=Math.floor(t/o),w=4*t,x={r:j.data[w],g:j.data[w+1],b:j.data[w+2],a:j.data[w+3]};if(h(x,l,c)&&r[t]!==!0&&(r[t]=!0,j.data[w]=g.r,j.data[w+1]=g.g,j.data[w+2]=g.b,j.data[w+3]=g.a,v>0&&q.push(t-o),o-1>u&&q.push(t+1),p-1>v&&q.push(t+o),u>0&&q.push(t-1)),s>1e6)break}i.putImageData(j,0,0),this._oDrawing.pushCoords(b)},draw:function(){},endDraw:function(){}},Dessin.Pattern=function(a){_.extend(this,new Dessin.Line(a)),this.$initPattern()},Dessin.Pattern.prototype={$initPattern:function(){var a=Dessin.Utility.getImage(Dessin.BRUSH.RES_PATTERN_IMAGE_URL);this.createBrush(a)},setupEachConfig:function(a){a.globalCompositeOperation="source-over",a.globalAlpha=this._oModel.getColor().a,a.strokeStyle=a.createPattern(this._oNewImage,"repeat")}},Dessin.Pen=function(a){_.extend(this,new Dessin.Line(a))},Dessin.Pen.prototype={setupEachConfig:function(a){a.strokeStyle=this._oModel.getColor().toRGBAString()}},Dessin.Pick=function(a){this.$initPick(a)},Dessin.Pick.prototype={$initPick:function(){},startDraw:function(a,b){var c=b.x,d=b.y,e=a.getMergedCanvas(!0),f=e.width,g=e.height,h=e.getContext("2d"),i=h.getImageData(0,0,f,g),j=i.data,k=j[4*(f*d+c)],l=j[4*(f*d+c)+1],m=j[4*(f*d+c)+2],n=j[4*(f*d+c)+3];return new Dessin.ColorModel({r:k,g:l,b:m,a:n})},draw:function(){},endDraw:function(){}},Dessin.Text=function(){this.DRAW_MODE=Dessin.DRAW_MODE.SESSION,this.$init.apply(this,arguments)},Dessin.Text.prototype={TEXTAREA_TEMPLATE:'<textarea id="_dessin_text_input" style="padding-top:15px;border:0;letter-spacing:0px;box-sizing: border-box;line-height:1.15;padding-left:12px;opacity:0.3;display:block;width:300px;overflow:hidden;background-color:#FFCC00;left:0;top:0;height:100px;position:absolute;z-index:1000;"></textarea>',$init:function(a){this._htTouchEvent=Dessin.Touch.touchEvent(),this._oDrawing=new Dessin.Drawing,this._htCoords={x:0,y:0},this._nWidth=0,this._nHeight=0,this._oDrawing.setSize(a.size).setColor(a.color).setFontName(a.fontName||""),this._setElements()},_setElements:function(){$("#_dessin_text_input").length<=0&&$("._dessin_stage").prepend(this.TEXTAREA_TEMPLATE),this._welTextInput=$("#_dessin_text_input"),this._unsetEvents(),this._setEvents()},_unsetEvents:function(){this._welTextInput.off("keyup",$.proxy(this._onKeyUp,this)).off("focus",$.proxy(this._onFocusInput,this)).off("blur",$.proxy(this._onBlurInput,this))},_setEvents:function(){this._welTextInput.on("keyup",$.proxy(this._onKeyUp,this)).on("focus",$.proxy(this._onFocusInput,this)).on("blur",$.proxy(this._onBlurInput,this))},_onKeyUp:function(a){27===a.keyCode?this._drawRearCanvas():this._drawTextPrevCanvas()},_drawTextPrevCanvas:function(){this._bDrawCursor=!0,this._updateView()},_onFocusInput:function(){this._bDrawCursor=!0},_onBlurInput:function(){this._bDrawCursor=!1},_updateView:function(){this.oLayer&&this._draw(this.oLayer,null)},_getMaxString:function(a){var b=a.split("\n"),c=_.max(b,function(a){return a.length});return c},startDraw:function(a,b){this._htCoords=b;var c=this;setTimeout(function(){c._welTextInput.focus()},100),this._draw(a,b)},_draw:function(a,b){this.oLayer=a,b&&(this._htCoords=b),this.oLayer.clearPreLayer(),this.drawTextToCanvas(a.getPreLayerElement(),this._htCoords,!0)},draw:function(){},endDraw:function(){},_initContext:function(a){var b=a.getContext("2d");return b.font=this._oDrawing.getSize()+"px "+this._oDrawing.getFontName(),b.fillStyle=this._oDrawing.getColor().toRGBString(),b.textAlign="start",b.textBaseline="alphabetic",b},_getHeight:function(a){var b=a.measureText("W").width;return b+b/6},drawTextToCanvas:function(a,b,c){var d=this._initContext(a),e=this._oDrawing.getSize(),f=this._welTextInput.val(),g=a.width-b.x,h=150,i=b.x,j=b.y,k=f.split("\n").length;d.wrapText(f,i,j,g,e);var l=Math.max(h,g);c===!0&&this._drawDottedBox(d,i,j,l,e*k),this._welTextInput.css({left:-1e3,top:-1e3,fontSize:this.fontSize+"px",opacity:0}),this._bDrawCursor&&this._drawCursor(d,{el:$("#_dessin_text_input")[0],sText:f,nFontSize:e,htCoords:_.clone(b)})},_drawCursor:function(a,b){var c=b.el,d=b.sText,e=b.value,f=b.htCoords,g=this._getInputSelection(c),h=d.substr(0,g.start).split("\n").length-1,i=d.split("\n")[h],j=d.substr(g.start,d.length-1).split("\n")[0],k=d.substr(g.end,d.length-1).split("\n")[0],l=a.measureText(i.substr(0,i.length-j.length)),m=a.measureText(i.substr(0,i.length-k.length)),n=h*this._oDrawing.getSize()+2;a.fillStyle="rgba(0,0,0,0.2)",a.fillRect(f.x+l.width,f.y+n,m.width!==l.width?m.width-l.width:2,e)},_drawRearCanvas:function(){this._bDrawCursor=!1;var a=this.oLayer.getLayerElement();this.drawTextToCanvas(a,this._htCoords,!1),this.oLayer.clearPreLayer(),this._unsetEvents(),this._welTextInput.val(""),this._welTextInput.remove()},isInbound:function(a,b){return a.x>b.x&&a.y>b.y&&a.x<b.x+this._nWidth&&a.y<b.y+this._nHeight},_drawDottedBox:function(a,b,c,d,e){a.dashedLine(b,c,b+d,c,1),a.dashedLine(b,c+e,b,c,1),a.dashedLine(b,c+e,b+d,c+e,1),a.dashedLine(b+d,c,b+d,c+e,1)},_getInputSelection:function(a){var b,c,d,e,f,g=0,h=0;return"number"==typeof a.selectionStart&&"number"==typeof a.selectionEnd?(g=a.selectionStart,h=a.selectionEnd):(c=document.selection.createRange(),c&&c.parentElement()==a&&(e=a.value.length,b=a.value.replace(/\r\n/g,"\n"),d=a.createTextRange(),d.moveToBookmark(c.getBookmark()),f=a.createTextRange(),f.collapse(!1),d.compareEndPoints("StartToEnd",f)>-1?g=h=e:(g=-d.moveStart("character",-e),g+=b.slice(0,g).split("\n").length-1,d.compareEndPoints("EndToEnd",f)>-1?h=e:(h=-d.moveEnd("character",-e),h+=b.slice(0,h).split("\n").length-1)))),{start:g,end:h}}},CanvasRenderingContext2D.prototype.dashedLine=function(a,b,c,d,e){void 0==e&&(e=2),this.beginPath(),this.moveTo(a,b);for(var f=c-a,g=d-b,h=Math.floor(Math.sqrt(f*f+g*g)/e),i=f/h,j=g/h,k=0;k++<h;)a+=i,b+=j,this[k%2==0?"moveTo":"lineTo"](a,b);this[k%2==0?"moveTo":"lineTo"](c,d),this.stroke(),this.closePath()},CanvasRenderingContext2D.prototype.wrapText=function(a,b,c,d,e){for(var f=a.split("\n"),g=0;g<f.length;g++){for(var h=f[g].split(" "),i="",j=0;j<h.length;j++){var k=i+h[j]+" ",l=this.measureText(k),m=l.width;m>d&&j>0?(this.fillText(i,b,c),i=h[j]+" ",c+=e):i=k}c+=e,this.fillText(i,b,c)}},Dessin.App=function(){this.$init.apply(this,arguments)},Dessin.App.prototype={DEFAULT_LAYER_COUNT:3,DEFAULT_WIDTH:250,DEFAULT_HEIGHT:250,$init:function(a,b){this.nLayerCount=b.nLayerCount||this.DEFAULT_LAYER_COUNT,this.nWidth=b.nWidth||this.DEFAULT_WIDTH,this.nHeight=b.nHeight||this.DEFAULT_HEIGHT,this.welStageWrapper=a,this._preLoadResources(),this.oController=new Dessin.Controller(this.welStageWrapper,{defaultLayerCount:this.nLayerCount,defaultWidth:this.nWidth,defaultHeight:this.nHeight,oPainter:this}),this.oModel=this.oController.oModel,this.oLayers=this.oController.oLayers},_preLoadResources:function(){Dessin.Utility.setBrushImage(Dessin.BRUSH.RES_BRUSH_IMAGE_URL),Dessin.Utility.setBrushImage(Dessin.BRUSH.RES_CRAYON_IMAGE_URL),Dessin.Utility.setBrushImage(Dessin.BRUSH.RES_AIR_BRUSH_IMAGE_URL),Dessin.Utility.setBrushImage(Dessin.BRUSH.RES_PATTERN_IMAGE_URL)},undo:function(){this.oController.undo()},redo:function(){this.oController.redo()},draw:function(a){this.oController.draw(a)},getCurrentLayer:function(){return this.oController.getCurrentLayer()},setCurrentLayerNumber:function(a){this.oController.setCurrentLayerNumber(a)},getLayer:function(a){return this.oController.getLayer(a)},addSnapShots:function(){this.oController.addSnapShots()},clearAllPreLayers:function(){this.oLayers.clearPreLayers()},zoomIn:function(a){this.oController.zoomIn(a),this.clearAllPreLayers()},zoomOut:function(a){this.oController.zoomOut(a),this.clearAllPreLayers()},zoomMove:function(a){this.oController.zoomMove(a)},setZoomType:function(a){this.oModel.setZoomType(a)},resetLayers:function(){this.oController.clearAllLayers()}},Dessin.ColorModel=function(){this.$init.apply(this,arguments)},Dessin.ColorModel.prototype={$init:function(){var a={r:0,g:0,b:0,a:1};if(arguments.length>0){var b=arguments[0];"string"==typeof b&&(a=this._convertStrToObj(b)),"object"==typeof b&&(a=b)}this.r=a.r,this.g=a.g,this.b=a.b,this.a=a.a},_convertStrToObj:function(a){var b=a.substring(a.indexOf("(")+1,a.lastIndexOf(")")).split(/,\s*/);return{r:parseInt(b[0],10),g:parseInt(b[1],10),b:parseInt(b[2],10),a:parseFloat(b[3])}},toRGBAString:function(){return["rgba(",this.r,",",this.g,",",this.b,",",this.a,")"].join("")},toRGBString:function(){return["rgba(",this.r,",",this.g,",",this.b,",",1,")"].join("")}},Dessin.Controller=function(){this.$init.apply(this,arguments)},Dessin.Controller.prototype={$init:function(a,b){this.oPersistentStore=new Dessin.PersistentStore({delay:250}),this.welStageWrapper=a,this.oModel=new Dessin.Model({aSelectedColors:this.oPersistentStore.getItem("Dessin.Colors"),nSelectedToolNumber:this.oPersistentStore.getItem("Dessin.Tool"),defaultWidth:b.defaultWidth,defaultHeight:b.defaultHeight});var c={defaultLayerCount:b.defaultLayerCount,defaultWidth:b.defaultWidth,defaultHeight:b.defaultHeight};this.oLayers=new Dessin.Layers(this.welStageWrapper,c),this.oSnapshots=new Dessin.Snapshots(c),$(this.oModel).on("model.pick",$.proxy(this._setColorToPersistentStore,this)).on("model.tool",$.proxy(this._setToolToPersistentStore,this))},_setColorToPersistentStore:function(a,b){this.oPersistentStore.setItem("Dessin.Colors",b.colors)},_setToolToPersistentStore:function(a,b){return b.tool==Dessin.TOOL.PICK?!1:void this.oPersistentStore.setItem("Dessin.Tool",b.tool)},addSnapShots:function(){this.oSnapshots.addSnapShot(this.oLayers)},undo:function(){var a=this.oSnapshots.undo();return 0===a.length?!1:void _.each(a,$.proxy(this._putLayerImageData,this))},redo:function(){var a=this.oSnapshots.redo();return 0===a.length?!1:void _.each(a,$.proxy(this._putLayerImageData,this))},_putLayerImageData:function(a){var b=a.nLayerId,c=this.oLayers.getLayer(b),d=c.getLayerElement(),e=c.getLayerContext(),f=this._saveCanvas(a.oSnapShot),g=d.width,h=d.height;c.clearLayer(),e.drawImage(f,0,0,g,h)},setPreLayerZoomLevel:function(){var a=this.oModel.getZoomLevel(),b=this.oModel.getOriginCanvasWidth()*a,c=this.oModel.getOriginCanvasHeight()*a;this.getCurrentLayer().setPreLayerWidth(b),this.getCurrentLayer().setPreLayerHeight(c)},setCurrentLayerNumber:function(a){this.oModel.setCurrentLayerNumber(a),this.oLayers.appendPreLayerBy(this.getCurrentLayer()),this.setPreLayerZoomLevel()},getCurrentLayer:function(){var a=this.oModel.getCurrentLayerNumber();return this.oLayers.getLayer(a)},getLayer:function(a){return this.oLayers.getLayer(a)},zoomIn:function(a){var b=this.oModel;b.isAvailAddZoomLevel()!==!1&&(b.addZoomLevel(),b.setZoomType(a),this._resizeCanvas(b))},zoomOut:function(a){var b=this.oModel;b.isAvailSubtractZoomLevel()!==!1&&(b.subtractZoomLevel(),b.setZoomType(a),this._resizeCanvas(b))},zoomMove:function(a){this.oModel.getZoomLevel()>1&&this.oModel.setZoomType(a)},_saveCanvas:function(a){var b=$("<canvas>").attr("width",a.width).attr("height",a.height)[0],c=b.getContext("2d");return c.putImageData(a,0,0),b},_resizeCanvas:function(a){for(var b=a.getZoomLevel(),c=a.getOriginCanvasWidth()*b,d=a.getOriginCanvasHeight()*b,e=this.oLayers,f=null,g=null,h=null,i=0,j=e.getLayersLength();j>i;i+=1)f=e.getLayer(i),h=f.getLayerContext(),g=this._saveCanvas(f.getLayerImageData()),f.setLayerWidth(c),f.setLayerHeight(d),h.imageSmoothingEnabled=!1,h.mozImageSmoothingEnabled=!1,h.oImageSmoothingEnabled=!1,h.webkitImageSmoothingEnabled=!1,h.drawImage(g,0,0,c,d);this.setPreLayerZoomLevel();var k=this.welStageWrapper.find("#_surface");k.attr("width",c),k.attr("height",d),a.setCanvasSize(c,d)},clearAllLayers:function(){this.oLayers.clearLayers(),this.oSnapshots.clearSnapShot()}},Dessin.Drawing=function(){this.$init.apply(this,arguments)},Dessin.Drawing.prototype={$init:function(){this._aCoords=[],this._nSize=0,this._sStylar="round",this._oColor=null,this._sFontName=""},get:function(){return JSON.parse(JSON.stringify(this))},pushCoords:function(a){return this._aCoords.push(a),this},getCoords:function(){return this._aCoords},getSize:function(){return this._nSize},setSize:function(a){return this._nSize=a,this},getStylar:function(){return this._sStylar},setStylar:function(a){return this._sStylar=a,this},getColor:function(){return this._oColor},setColor:function(a){return this._oColor=a,this},getFontName:function(){return this._sFontName},setFontName:function(a){return this._sFontName=a,this}},Dessin.Layer=function(){this.$init.apply(this,arguments)},Dessin.Layer.prototype={$init:function(a){this.layerId=a.layerId,this.isVisible=a.isVisible},getLayerId:function(){return this.layerId},getLayerImageData:function(){var a=this.getLayerElement(),b=a.getContext("2d");return b.getImageData(0,0,a.width,a.height)},clearPreLayer:function(){var a=this.getPreLayerElement();if(a){var b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)}},clearLayer:function(){var a=this.getLayerElement();if(a){var b=a.getContext("2d");b.clearRect(0,0,a.width,a.height)}},getLayerElement:function(){return $('._stage[data-seq="'+this.layerId+'"] >canvas')[0]},getPreLayerElement:function(){return $('._stage[data-seq="'+this.layerId+'"] ._pre_layer canvas')[0]},getLayerContext:function(){return this.getLayerElement().getContext("2d")},getPreLayerContext:function(){return this.getPreLayerElement().getContext("2d")},setLayerWidth:function(a){$(this.getLayerElement()).attr("width",a)},setLayerHeight:function(a){$(this.getLayerElement()).attr("height",a)},setPreLayerWidth:function(a){$(this.getPreLayerElement()).attr("width",a)},setPreLayerHeight:function(a){$(this.getPreLayerElement()).attr("height",a)},showLayer:function(){this.getLayerElement().style.display="block",this.isVisible=!0},hideLayer:function(){this.getLayerElement().style.display="none",this.isVisible=!1}},Dessin.Layers=function(){this.$init.apply(this,arguments)},Dessin.Layers.prototype={LAYER_TMPL:'<div class="_stage" style="position:absolute;" data-seq="<%= seq %>"><canvas width="<%= width %>" height="<%= height %>" class="_surface"></canvas></div>',PRE_LAYER_TMPL:'<div class="_pre_layer" style="position:absolute;"><canvas width="<%= width %>" height="<%= height %>" class="_surface"></canvas></div>',SURFACE_TMPL:'<div class="_stage" style="position:absolute;z-index: 1;"><canvas id="_surface" width="<%= width %>" height="<%= height %>" class="_surface"></canvas></div>',$init:function(a,b){this._aLayers=[],this._welStageWrapper=a,this._createLayerView(b.defaultWidth,b.defaultHeight,b.defaultLayerCount),this._initPreLayer()},_createLayerView:function(a,b,c){for(var d=[],e=0,f=c;f>e;e++){var g=_.template(this.LAYER_TMPL,{seq:e,width:a,height:b});d.push(g),this._addLayer(e)}d.reverse();var h=_.template(this.SURFACE_TMPL,{width:a,height:b});d.unshift(h),this._welStageWrapper.css({width:a+"px",height:b+"px"}).html(d.join(""))},_addLayer:function(a){var b=new Dessin.Layer({layerId:a,isVisible:!0});this._aLayers.push(b)},_initPreLayer:function(){var a=this.getLayer(0);this.appendPreLayerBy(a)},appendPreLayerBy:function(a){this._welStageWrapper.find("._pre_layer").remove();var b=$(a.getLayerElement()).parent(),c=b.width(),d=b.height(),e=_.template(this.PRE_LAYER_TMPL,{width:c,height:d});b.prepend(e)},clearPreLayers:function(){for(var a=this._aLayers,b=0,c=a.length;c>b;b++)a[b].clearPreLayer()},clearLayers:function(){for(var a=this._aLayers,b=0,c=a.length;c>b;b++)a[b].clearLayer()},getLayersLength:function(){return this._aLayers.length},getLayer:function(a){return this._aLayers[a]},getLayers:function(){return this._aLayers},getMergedCanvas:function(a){var a=!!a,b=this.getLayers(),c=_.where(b,{isVisible:a}),d=document.createElement("canvas"),e=b[0].getLayerImageData();d.width=e.width,d.height=e.height;var f=d.getContext("2d");f.fillStyle="rgba(255,255,255,1)",f.fillRect(0,0,d.width,d.height);for(var g=c.length-1;g>=0;g--){var h=c[g].getLayerElement();f.drawImage(h,0,0)}return d}},Dessin.Model=function(){this.$init.apply(this,arguments)},Dessin.Model.prototype={MIN_TOOL_SIZE:1,MAX_TOOL_SIZE:50,MIN_TOOL_BLUR_SIZE:.1,MAX_TOOL_BLUR_SIZE:1,MIN_FONT_SIZE:10,MAX_FONT_SIZE:30,_$initProp:function(a){this._nSelectedToolNumber=a.nSelectedToolNumber||Dessin.TOOL.NONE,this._aSelectedColors=a.aSelectedColors||[],this._sFontName="굴림체",this._nFontSize=10,this._nToolSize=5,this._nToolBlur=.5,this._nCurrentLayer=0,this._nZoomLevel=1,this._nOriginalCanvasWidth=0,this._nOriginalCanvasHeight=0,this._nCanvasWidth=0,this._nCanvasHeight=0,this._sText="",this._sZoomType="",this._oSelectedColor=this.getSelectedColor(),this.setSelectedColor()},$init:function(a){this._$initProp(a),this._setOriginCanvasSize(a.defaultWidth,a.defaultHeight),this.setCanvasSize(a.defaultWidth,a.defaultHeight)},_setOriginCanvasSize:function(a,b){this._nOriginalCanvasWidth=a,this._nOriginalCanvasHeight=b},getOriginCanvasWidth:function(){return this._nOriginalCanvasWidth},getOriginCanvasHeight:function(){return this._nOriginalCanvasHeight},getFontName:function(){return this._sFontName},setFontName:function(a){this._sFontName=a},getCurrentLayerNumber:function(){return this._nCurrentLayer},setCurrentLayerNumber:function(a){this._nCurrentLayer=a},getCanvasWidth:function(){return this._nCanvasWidth},getCanvasHeight:function(){return this._nCanvasHeight},setCanvasSize:function(a,b){this._nCanvasWidth=a,this._nCanvasHeight=b},isAvailAddZoomLevel:function(){return this._nZoomLevel>Dessin.ZOOM_LEVEL.MIN&&this._nZoomLevel<Dessin.ZOOM_LEVEL.MAX},addZoomLevel:function(){this.isAvailAddZoomLevel()&&(this._nZoomLevel+=1)},isAvailSubtractZoomLevel:function(){return this._nZoomLevel>1},subtractZoomLevel:function(){this.isAvailSubtractZoomLevel()&&(this._nZoomLevel-=1)},getZoomLevel:function(){return this._nZoomLevel},setZoomType:function(a){this._sZoomType=a,this._nSelectedToolNumber=Dessin.TOOL.NONE,$(this).trigger("model.tool",{tool:this._nSelectedToolNumber})},getZoomType:function(){return this._sZoomType},getFontSize:function(){return this._nFontSize},setFontSize:function(a){this._nFontSize=this._getBetweenMinAndMax(this.MIN_FONT_SIZE,this.MAX_FONT_SIZE,a)},setToolBlur:function(a){this._nToolBlur=this._getBetweenMinAndMax(this.MIN_TOOL_BLUR_SIZE,this.MAX_TOOL_BLUR_SIZE,a),this._oSelectedColor.a=this._nToolBlur},getToolBlur:function(){return this._nToolBlur},getToolSize:function(){return this._nToolSize},setToolSize:function(a){this._nToolSize=this._getBetweenMinAndMax(this.MIN_TOOL_SIZE,this.MAX_TOOL_SIZE,a)},setSelectedFontName:function(a){this._sFontName=a},getSelectedFontName:function(){return this._sFontName},setSelectedToolNumber:function(a){this._nSelectedToolNumber=a,this._sZoomType=Dessin.LAYER_ACTION.NONE,$(this).trigger("model.tool",{tool:a})},getSelectedToolNumber:function(){return this._nSelectedToolNumber},getSelectedToolName:function(){var a=this._nSelectedToolNumber;return _.invert(Dessin.TOOL)[a]},getSelectedColor:function(){return this._oSelectedColor},setSelectedColor:function(a){this._oSelectedColor=a||new Dessin.ColorModel,this._oSelectedColor.a=this.getToolBlur(),$(this).trigger("model.color",a)},getSelectedColors:function(){return this._aSelectedColors},pushSelectedColors:function(a){var b=this._aSelectedColors;return this._hasColor(b,a)?!1:(this._isFullPalette(b)&&this._aSelectedColors.shift(),this._aSelectedColors.push(a),void $(this).trigger("model.pick",{colors:this._aSelectedColors,color:a}))},_hasColor:function(a,b){var c=_.where(a,b);return c.length>0?!0:!1},_isFullPalette:function(a){return a.length>=Dessin.ui.DEFAULT_MAX_SAVE_COLOR_COUNT},_getBetweenMinAndMax:function(a,b,c){return a>c||c>b?Math.min(Math.max(a,c),b):c}},Dessin.PersistentStore=function(a){this.options=_.extend({clearable:!0,delay:2e3,maximum:5},a),this.$init()},Dessin.PersistentStore.prototype={$init:function(){"undefined"==typeof localStorage&&"undefined"!=typeof globalStorage&&(window.localStorage=globalStorage[location.hostname]),this.localStorage=window.localStorage,this.localStorage||(this.localStorage={getItem:function(a){return this.data=window.name?window.name.evalJSON():{},$(this.data[a]||JSON.stringify(this.data[a]={}))},setItem:function(a,b){this.data[a]=b.evalJSON(),window.name=JSON.stringify(this.data)},removeItem:function(a){delete this.data[a],window.name=JSON.stringify(this.data)}})},getItem:function(a){try{return JSON.parse(this.localStorage.getItem(a).toString())}catch(b){this.options.clearable}},setItem:function(a,b){(void 0!==b||null!==b)&&(this.data=b),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){if(!(this.size(!0,a)>1048576*this.options.maximum))try{this.localStorage.setItem(a,JSON.stringify(this.data))}catch(b){this.options.clearable&&this.set({})}}.bind(this),this.options.delay)},remove:function(a){this.localStorage.removeItem(a)},clear:function(){var a=this.localStorage.length;if(a)for(var b=0;a>b;b++)this.remove(this.localStorage.key(b));else window.name="{}"},size:function(a,b){var c=this.getItem(b);if(!c)return!1;var d=JSON.stringify(c).length;return a?d:d>1024?function(){d=(d/1024).round().toString();for(var a=/(^[+-]?\d+)(\d{3})/;a.test(d);)d=d.replace(a,"$1,$2");return d+"kb"}():d+"bytes"}},Dessin.Snapshots=function(){this.$init.apply(this,arguments)},Dessin.Snapshots.prototype={$init:function(a){this._htCanvasInfo=a,this.clearSnapShot()},clearSnapShot:function(){this._aRepository=[],this._nCursor=-1,this._nCurrent=-1},_getBlankImageData:function(){var a=document.createElement("canvas"),b=a.getContext("2d");return b.createImageData(this._htCanvasInfo.defaultWidth,this._htCanvasInfo.defaultHeight)},_getPreviousData:function(){return this._nCursor-=1,this._aRepository[this._nCursor]},_getNextData:function(){return this._nCursor+=1,this._aRepository[this._nCursor]},_spliceRepositoryByStart:function(a){this._aRepository.splice(a);var b=this._aRepository.length-1;this._nCurrent=b,this._nCursor=b},addSnapShot:function(a){this._nCurrent!==this._nCursor&&this._spliceRepositoryByStart(this._nCursor+1),this._aRepository.length<1&&this._addAllImageData(a,!0),this._addAllImageData(a,!1)},_addAllImageData:function(a,b){for(var c=[],d=0,e=a.getLayersLength();e>d;d+=1){var f=a.getLayer(d),g=f.getLayerId();c.push({nLayerId:g,oSnapShot:this._getImageDataBy(b,f)})}this._nCursor+=1,this._nCurrent+=1,this._aRepository[this._nCursor]=c},_getImageDataBy:function(a,b){return a?this._getBlankImageData():b.getLayerImageData()},undo:function(){var a=this._getPreviousData();return a?this._aRepository[this._nCursor]:(this._nCursor+=1,!1)},redo:function(){var a=this._getNextData();return a?this._aRepository[this._nCursor]:(this._nCursor-=1,!1)}},Dessin.ToolSimpleFactory=function(){},Dessin.ToolSimpleFactory.prototype={createDrawing:function(a,b){var c,d=Dessin.TOOL,e=b.oColor,f=b.nToolSize,g=b.sFontName,h=b.nFontSize;switch(a){case d.PEN:c=new Dessin.Pen({color:e,size:f});break;case d.BRUSH:c=new Dessin.Brush({color:e,size:f});break;case d.CRAYON:c=new Dessin.Crayon({color:e,size:f});break;case d.AIR_BRUSH:c=new Dessin.AirBrush({color:e,size:f});break;case d.PAINT:c=new Dessin.Paint({color:e});break;case d.ERASER:c=new Dessin.Eraser({size:f});break;case d.PATTERN:c=new Dessin.Pattern({color:e,size:f});break;case d.TEXT:c=new Dessin.Text({color:e,size:h,fontName:g});break;case d.PICK:c=new Dessin.Pick({})}return c}},Dessin.ToolSimpleFactory.getInstance=function(){return null==Dessin.ToolSimpleFactory.instance&&(Dessin.ToolSimpleFactory.instance=new Dessin.ToolSimpleFactory),Dessin.ToolSimpleFactory.instance},Dessin.ToolSimpleFactory.instance=null,Dessin.ui.ColorPickerUI=function(){this.$init.apply(this,arguments)},Dessin.ui.ColorPickerUI.prototype={$init:function(a){this._oPainter=a,this._oModel=a.oModel,this._setElements(),this._setEvents(),this.updatePalette(),this._initComponents(),this.updateColorSlider(this._oModel.getSelectedColor())},_setElements:function(){this._welSelectedColors=$("#selected_colors"),this._welRed=$("#_red_slider"),this._welGreen=$("#_green_slider"),this._welBlue=$("#_blue_slider"),this._welSwatch=$("#swatch")},_setEvents:function(){this._welSelectedColors.on("click","._color_palette_btn",$.proxy(this._onClickColorPaletteBtn,this)),$(this._oModel).on("model.pick",$.proxy(this._updateColorPicker,this))
},_updateColorPicker:function(a,b){this.updateColorSlider(b.color),this.updatePalette()},_onClickColorPaletteBtn:function(a){var b=$(a.currentTarget).attr("data-color");this.updateColorSlider(new Dessin.ColorModel(b))},_initComponents:function(){$("#_red_slider, #_green_slider, #_blue_slider").slider({range:"min",min:0,max:255,change:$.proxy(this._setSwatch,this)})},_hexFromRGB:function(a,b,c){var d=[a.toString(16),b.toString(16),c.toString(16)];return $.each(d,function(a,b){1===b.length&&(d[a]="0"+b)}),d.join("").toUpperCase()},_setSwatch:function(){var a=this._welRed.slider("value"),b=this._welGreen.slider("value"),c=this._welBlue.slider("value"),d=this._hexFromRGB(a,b,c);this._welSwatch.css("background-color","#"+d),this._oModel.setSelectedColor(new Dessin.ColorModel({r:a,g:b,b:c}))},updateColorSlider:function(a){this._welRed.slider("value",a.r),this._welGreen.slider("value",a.g),this._welBlue.slider("value",a.b),this._setSwatch()},updatePalette:function(){for(var a='<div class="_color_palette_btn palette_color" data-color="<%= color %>" style="background-color:<%= color %>"></div>',b=[],c="",d=this._oModel.getSelectedColors(),e=0;e<Dessin.ui.DEFAULT_MAX_SAVE_COLOR_COUNT;e++)c=d[e]?new Dessin.ColorModel(d[e]).toRGBString():"rgba(255,255,255,1)",b.push(_.template(a,{color:c}));this._welSelectedColors.html(b.join(""))}},Dessin.ui.DrawingUI=function(){this.$init.apply(this,arguments)},Dessin.ui.DrawingUI.prototype={$init:function(a,b){this._oPainter=a,this._oModel=a.oModel,this._oDrawing=b,this._welSurface=a.welStageWrapper.find("#_surface"),this._bDrawBegin=!1,this._nSelectedToolNumber=this._oModel.getSelectedToolNumber()},onTouchDown:function(a){switch(this._nSelectedToolNumber){case Dessin.TOOL.PICK:var b=this._oDrawing.startDraw(this._oPainter.oLayers,a);this._oModel.pushSelectedColors(b);break;default:if(void 0===this._oDrawing)return!1;this._oLayer=this._oPainter.getCurrentLayer(),this._oDrawing.startDraw(this._oLayer,a)}this._bDrawBegin=!0},onTouchMove:function(a){this._bDrawBegin&&(this._oLayer=this._oPainter.getCurrentLayer(),this._oDrawing.draw(this._oLayer,a))},onTouchUp:function(a){this._bDrawBegin&&this._oDrawing.endDraw(this._oLayer,a),this._bDrawBegin=!1}},Dessin.ui.LayerController=function(){this.$init.apply(this,arguments)},Dessin.ui.LayerController.prototype={$init:function(a){this.oPainter=a,this._oModel=a.oModel,this._welStageWrapper=a.welStageWrapper,this._welSurface=this._welStageWrapper.find("#_surface"),this._setEvents()},_setEvents:function(){var a=Dessin.Touch.touchEvent();this._welStageWrapper.on(a.touchStartEvent,$.proxy(this._onTouchDownOnStage,this)).on(a.touchMoveEvent,$.proxy(this._onTouchMoveOnStage,this)),$(document).on(a.touchStopEvent,$.proxy(this._onTouchUpOnDocument,this)).on("selectstart",function(a){a.preventDefault()})},_isZoomMove:function(){return this._oModel.getZoomType()===Dessin.LAYER_ACTION.ZOOMMOVE},_isTextTool:function(){return this._oModel.getSelectedToolNumber()===Dessin.TOOL.TEXT},_isPickTool:function(){return this._oModel.getSelectedToolNumber()===Dessin.TOOL.PICK},_createContorollerUIFactory:function(){this._isZoomMove()?this.oUI=new Dessin.ui.LayerUI(this.oPainter):(this._oDrawing=this._createDrawingFromFactory(),this.oUI=this._isTextTool()?Dessin.ui.TextUI.getInstance(this.oPainter,this._oDrawing):new Dessin.ui.DrawingUI(this.oPainter,this._oDrawing))},_onTouchDownOnStage:function(a){this._createContorollerUIFactory();var b=this._getAbsCoordinate(a.originalEvent);this.oUI.onTouchDown(b),this._drawSurfacePointer(b)},_onTouchMoveOnStage:function(a){a.preventDefault();var b=this._getAbsCoordinate(a.originalEvent);this._drawSurfacePointer(b),this.oUI&&this.oUI.onTouchMove(b)},_onTouchUpOnDocument:function(a){if(this.oUI){if(this._isTextTool())return!0;if(this.oUI.onTouchUp(this._getAbsCoordinate(a.originalEvent)),this.oUI=null,this.oPainter.clearAllPreLayers(),this._isPickTool()||this._isZoomMove())return!0;this.oPainter.addSnapShots()}this.clearSurface()},_drawSurfacePointer:function(a){this._nSelectedToolNumber===Dessin.TOOL.TEXT?this._setSurfaceCursorStyle("text"):(this._setSurfaceCursorStyle("crosshair"),this._drawPointer(a))},_setSurfaceCursorStyle:function(a){return this._welSurface.css("cursor")===a?!1:void this._welSurface.css("cursor",a)},_drawPointer:function(a){var b=this.clearSurface();b.strokeStyle=this._oModel.getSelectedColor().toRGBAString(),b.beginPath(),b.arc(a.x,a.y,this._oModel.getToolSize()/2,0,2*Math.PI,!0),b.closePath(),b.stroke()},_getSurfaceContext:function(){return this._welSurface[0].getContext("2d")},clearSurface:function(){var a=this._getSurfaceContext();return a.clearRect(0,0,this._welSurface.width(),this._welSurface.height()),a},_getAbsCoordinate:function(a){return a=Dessin.Touch.hasRealTouch()?a.changedTouches[0]:a,{x:Math.ceil(a.clientX-this._welSurface.offset().left+window.scrollX),y:Math.ceil(a.clientY-this._welSurface.offset().top+window.scrollY)}},_createDrawingFromFactory:function(){var a=this._oModel,b=Dessin.ToolSimpleFactory.getInstance().createDrawing(a.getSelectedToolNumber(),{oColor:a.getSelectedColor(),nToolSize:a.getZoomLevel()*a.getToolSize(),nFontSize:a.getFontSize(),sFontName:a.getFontName()});return b}},Dessin.ui.LayerUI=function(){this.$init.apply(this,arguments)},Dessin.ui.LayerUI.prototype={$init:function(a){this._welStageWrapper=a.welStageWrapper,this._bZoomMove=!1},onTouchDown:function(a){this._htStartCoords=a,this._bZoomMove=!0},onTouchMove:function(a){if(this._bZoomMove!==!1){var b=this._htStartCoords,c=b.y-a.y,d=b.x-a.x,e=this._welStageWrapper;e.scrollTop(e.scrollTop()+c),e.scrollLeft(e.scrollLeft()+d)}},onTouchUp:function(){this._bZoomMove=!1}},Dessin.ui.LayerUI.constructor=Dessin.ui.LayerUI,Dessin.ui.TextUI=function(){this.$init.apply(this,arguments)},Dessin.ui.TextUI.prototype={$init:function(a,b){this._oPainter=a,this._oModel=a.oModel,this._oDrawing=b,this._nSelectedToolNumber=this._oModel.getSelectedToolNumber(),this._oLayer=this._oPainter.getCurrentLayer(),this._bFlag=!1},onTouchDown:function(a){this._bFlag===!1?(this._oDrawing.startDraw(this._oLayer,a),this._bFlag=!0):(this._oDrawing._drawRearCanvas(),this._oPainter.addSnapShots(),this._bFlag=!1,this._oDrawing=null,Dessin.ui.TextUI.instance=null)},onTouchMove:function(){},onTouchUp:function(){}},Dessin.ui.TextUI.getInstance=function(a,b){return null==Dessin.ui.TextUI.instance&&(Dessin.ui.TextUI.instance=new Dessin.ui.TextUI(a,b)),Dessin.ui.TextUI.instance},Dessin.ui.TextUI.instance=null,Dessin.ui.ToolUI=function(){this.$init.apply(this,arguments)},Dessin.ui.ToolUI.prototype={$init:function(a){this._oPainter=a,this._oModel=a.oModel,this._setElements(),this._setEvents(),this._setComponents(),this._updatePreviewBrush(),this._updateSelectedTool()},_setElements:function(){this._welPicker=$("._pick_color_btn"),this._welToolSection=$("._tool_section"),this._welLayerBtnSection=$("._layer_btn_section"),this._welBrushPreview=$("._brush_preview"),this._welFontNameSelect=$("#_font_select"),this._welLayerTransformBtn=$("._layer_transform_btn_section"),this._welAirbrushPannel=$("._airbrush_setting"),this._welTextPannel=$("._text_option_stage")},_setEvents:function(){this._welLayerBtnSection.on("click","button",$.proxy(this._onClickSelectLayer,this)),this._welLayerBtnSection.on("click","span",$.proxy(this._onClickVisibleLayer,this)),this._welLayerTransformBtn.on("click","button",$.proxy(this._onClickLayerTransformBtn,this)),this._welToolSection.on("click","button",$.proxy(this._onClickTool,this)),this._welPicker.on("click",$.proxy(this._onClickTool,this)),this._welFontNameSelect.on("change",$.proxy(this._onChangeFontSelect,this)),$(this._oModel).on("model.color",$.proxy(this._updatePreviewBrush,this)),$(this._oModel).on("model.tool",$.proxy(this._updateSelectedTool,this))},_setComponents:function(){$("._brush_size_slider").slider({min:1,max:50,value:this._oModel.getToolSize(),change:$.proxy(this._onSelectedToolSize,this)}),$("._brush_opacity_slider").slider({min:.1,max:1,value:this._oModel.getToolBlur(),step:.1,change:$.proxy(this._onSelectedToolBlur,this)}),$("._text_size_slider").slider({min:10,max:30,value:this._oModel.getFontSize(),step:1,change:$.proxy(this._onSelectedFontSize,this)})},_onSelectedToolSize:function(a,b){this._oModel.setToolSize(b.value),this._updatePreviewBrush()},_onSelectedToolBlur:function(a,b){this._oModel.setToolBlur(b.value),this._updatePreviewBrush()},_onSelectedFontSize:function(a,b){this._oModel.setFontSize(b.value)},_onChangeFontSelect:function(a){var b=$(a.currentTarget).val();this._oModel.setFontName(b)},_onClickTool:function(a){var b=$(a.currentTarget),c=b.attr("data-tool-name");this._setToolActive(c,b),this._oModel.setSelectedToolNumber(Dessin.TOOL[c])},_setToolActive:function(a,b){var c="btn-primary";switch(this._welToolSection.find("button").removeClass(c),this._welPicker.removeClass(c),b.addClass(c),a){case"TEXT":this._welAirbrushPannel.hide(),this._welTextPannel.show();break;case"PICK":this._welAirbrushPannel.hide(),this._welTextPannel.hide();break;default:this._welAirbrushPannel.show(),this._welTextPannel.hide()}},_onClickSelectLayer:function(a){this._welLayerBtnSection.find("button").removeClass("btn-success");var b=$(a.currentTarget),c=parseInt(b.attr("data-layer-idx"),10);this._oPainter.setCurrentLayerNumber(c),b.addClass("btn-success")},_onClickVisibleLayer:function(a){var b=$(a.currentTarget),c=parseInt(b.parent().attr("data-layer-idx"),10),d=this._oPainter.getLayer(c);d.isVisible?(d.hideLayer(),b.text("X")):(d.showLayer(),b.text("O"))},_onClickLayerTransformBtn:function(a){var b=$(a.currentTarget).attr("data-type"),c=Dessin.LAYER_ACTION,d=c[b];switch(d){case c.ZOOMIN:this._oPainter.zoomIn(d);break;case c.ZOOMOUT:this._oPainter.zoomOut(d);break;case c.ZOOMMOVE:this._oPainter.zoomMove(d);break;case c.UNDO:this._oPainter.undo();break;case c.REDO:this._oPainter.redo();break;case c.RESET:this._oPainter.resetLayers()}},_updateSelectedTool:function(){var a=this._oModel.getSelectedToolName(),b=_.find(this._welToolSection.find("button"),function(b){return $(b).attr("data-tool-name")===a});this._setToolActive(a,$(b))},_updatePreviewBrush:function(){var a=this._welBrushPreview[0],b=a.width,c=a.height,d=a.getContext("2d");d.clearRect(0,0,b,c),d.lineWidth=this._oModel.getToolSize(),d.strokeStyle=this._oModel.getSelectedColor().toRGBAString(),d.lineCap="round",d.beginPath(),d.arc(b/2,c/2,.5,0,2*Math.PI,!0),d.stroke(),d.closePath()}};